"use strict";var _createClass=function(){function r(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(n,e,t){return e&&r(n.prototype,e),t&&r(n,t),n}}();function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"openRestaurantsDB",value:function(){return navigator.serviceWorker?idb.open("restaurant-reviews-db",1,function(n){switch(n.oldVersion){case 0:var e=n.createObjectStore("restaurants",{keyPath:"id"});e.createIndex("by-name","name"),e.createIndex("by-date","createdAt"),e.createIndex("by-cuisine","cuisine_type"),e.createIndex("by-neighborhood","neighborhood")}}):(console.log("This browser doesn't support Service Worker"),Promise.resolve())}},{key:"fetchRestaurants",value:function(r){var e=this;fetch(t.DATABASE_URL).then(function(n){return n.json()}).then(function(t){e.openRestaurantsDB().then(function(n){var e=n.transaction("restaurants","readwrite").objectStore("restaurants");t.forEach(function(n){e.put(n)}),e.index("by-date").openCursor(null,"prev").then(function(n){return n.advance(10)}).then(function n(e){if(e)return e.delete(),e.continue().then(n)}),r(null,t)})}).catch(function(n){e.openRestaurantsDB().then(function(n){n.transaction("restaurants").objectStore("restaurants").getAll().then(function(n){r(null,n)}).catch(function(n){return r(n,null)})}).catch(function(n){return r(n,null)})})}},{key:"fetchRestaurantById",value:function(r,a){t.fetchRestaurants(function(n,e){if(n)a(n,null);else{var t=e.find(function(n){return n.id==r});t?a(null,t):a("Restaurant does not exist",null)}})}},{key:"fetchRestaurantByCuisine",value:function(r,a){t.fetchRestaurants(function(n,e){if(n)a(n,null);else{var t=e.filter(function(n){return n.cuisine_type==r});a(null,t)}})}},{key:"fetchRestaurantByNeighborhood",value:function(r,a){t.fetchRestaurants(function(n,e){if(n)a(n,null);else{var t=e.filter(function(n){return n.neighborhood==r});a(null,t)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,a,u){t.fetchRestaurants(function(n,e){if(n)u(n,null);else{var t=e;"all"!=r&&(t=t.filter(function(n){return n.cuisine_type==r})),"all"!=a&&(t=t.filter(function(n){return n.neighborhood==a})),u(null,t)}})}},{key:"fetchNeighborhoods",value:function(a){t.fetchRestaurants(function(n,t){if(n)a(n,null);else{var r=t.map(function(n,e){return t[e].neighborhood}),e=r.filter(function(n,e){return r.indexOf(n)==e});a(null,e)}})}},{key:"fetchCuisines",value:function(a){t.fetchRestaurants(function(n,t){if(n)a(n,null);else{var r=t.map(function(n,e){return t[e].cuisine_type}),e=r.filter(function(n,e){return r.indexOf(n)==e});a(null,e)}})}},{key:"urlForRestaurant",value:function(n){return"./restaurant?id="+n.id}},{key:"imageUrlForRestaurant",value:function(n){return null==n.photograph?"/img/missing-image":"/img/"+n.photograph}},{key:"mapMarkerForRestaurant",value:function(n,e){return new google.maps.Marker({position:n.latlng,title:n.name,url:t.urlForRestaurant(n),map:e,animation:google.maps.Animation.DROP})}},{key:"cleanImageCache",value:function(){return t.openRestaurantsDB().then(function(n){if(n){var a=[];return n.transaction("restaurants").objectStore("restaurants").getAll().then(function(n){return n.forEach(function(n){n.photograph&&a.push(n.photograph)}),caches.open("restaurant-reviews-content-imgs")}).then(function(r){return r.keys().then(function(n){n.forEach(function(n){var e=new URL(n.url),t=e.pathnames.substring(0,e.pathnames.indexOf("_"));a.includes(t)||r.delete(n)})})})}})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}}]),t}();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIl0sIm5hbWVzIjpbIkRCSGVscGVyIiwibmF2aWdhdG9yIiwic2VydmljZVdvcmtlciIsImlkYiIsIm9wZW4iLCJQcm9taXNlIiwidXBncmFkZURiIiwib2xkVmVyc2lvbiIsInJlc3RhdXJhbnRzU3RvcmUiLCJjcmVhdGVPYmplY3RTdG9yZSIsImtleVBhdGgiLCJjcmVhdGVJbmRleCIsImNvbnNvbGUiLCJsb2ciLCJyZXNvbHZlIiwiY2FsbGJhY2siLCJfdGhpcyIsInRoaXMiLCJmZXRjaCIsIkRBVEFCQVNFX1VSTCIsInRoZW4iLCJyZXN0YXVyYW50cyIsImpzb24iLCJvcGVuUmVzdGF1cmFudHNEQiIsImRiIiwidHJhbnNhY3Rpb24iLCJvYmplY3RTdG9yZSIsInJlc3RhdXJhbnQiLCJvcGVuQ3Vyc29yIiwiY3Vyc29yIiwidHgiLCJmb3JFYWNoIiwiZGVsZXRlIiwiY29udGludWUiLCJkZWxldGVSZXN0IiwiZ2V0QWxsIiwiY2F0Y2giLCJzdG9yZSIsImVycm9yIiwiZmV0Y2hSZXN0YXVyYW50cyIsImZpbmQiLCJyIiwiaWQiLCJjdWlzaW5lIiwicmVzdWx0cyIsImZpbHRlciIsImN1aXNpbmVfdHlwZSIsIm5laWdoYm9yaG9vZCIsIm5laWdoYm9yaG9vZHMiLCJtYXAiLCJ2IiwiaSIsImluZGV4T2YiLCJ1bmlxdWVOZWlnaGJvcmhvb2RzIiwiY3Vpc2luZXMiLCJ1bmlxdWVDdWlzaW5lcyIsInBob3RvZ3JhcGgiLCJnb29nbGUiLCJwb3NpdGlvbiIsImxhdGxuZyIsInRpdGxlIiwibmFtZSIsInVybCIsInVybEZvclJlc3RhdXJhbnQiLCJhbmltYXRpb24iLCJtYXBzIiwiQW5pbWF0aW9uIiwiRFJPUCIsImltYWdlc05lZWRlZCIsInB1c2giLCJjYWNoZXMiLCJjYWNoZSIsImtleXMiLCJyZXF1ZXN0cyIsInJlcXVlc3QiLCJVUkwiLCJ1cmxJbmRleCIsInBhdGhuYW1lcyIsInN1YnN0cmluZyIsImluY2x1ZGVzIl0sIm1hcHBp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LEdBV0QsSUFBQVosRUFBQSxJQUFBYSxJQUFBRCxFQUFBWixLQWlEYWMsRUFBV2QsRUFBSWUsVUFBVUMsVUFBVSxFQUFHaEIsRUFBSWUsVUFBVXpCLFFBQVEsTUEvQzFFZ0IsRUFBQVcsU0FBQUgsSUFBQUwsRUFBQXZDLE9BQUEwQyxpREFyTEUsTUFBQSIsImZpbGUiOiJkYmhlbHBlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29tbW9uIGRhdGFiYXNlIGhlbHBlciBmdW5jdGlvbnMuXG4gKi9cbmNsYXNzIERCSGVscGVyIHtcblxuICAvKipcbiAgICogRGF0YWJhc2UgVVJMLlxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXG4gICAqL1xuICBzdGF0aWMgZ2V0IERBVEFCQVNFX1VSTCgpIHtcbiAgICBjb25zdCBwb3J0ID0gMTMzNztcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fS9yZXN0YXVyYW50c2A7XG4gIH1cblxuICAvKipcbiAgICogT3BlbiBkYXRhYmFzZVxuICAgKi9cbiAgc3RhdGljIG9wZW5SZXN0YXVyYW50c0RCKCkge1xuICAgIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBzZXJ2aWNlIHdvcmtlcixcbiAgICAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGhhdmluZyBhIGRhdGFiYXNlXG4gICAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlcikge1xuICAgICAgY29uc29sZS5sb2coJ1RoaXMgYnJvd3NlciBkb2VzblxcJ3Qgc3VwcG9ydCBTZXJ2aWNlIFdvcmtlcicpO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgaWYgKCEoJ2luZGV4ZWREQicgaW4gd2luZG93KSkge1xuICAgICAgICBjb25zb2xlLmxvZygnVGhpcyBicm93c2VyIGRvZXNuXFwndCBzdXBwb3J0IEluZGV4ZWREQicpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGlkYi5vcGVuKCdyZXN0YXVyYW50LXJldmlld3MtZGInLCAxLCBmdW5jdGlvbih1cGdyYWRlRGIpIHtcbiAgICAgIHN3aXRjaCAodXBncmFkZURiLm9sZFZlcnNpb24pIHtcbiAgICAgICAgY2FzZSAwOlxuICAgICAgICAgIGNvbnN0IHJlc3RhdXJhbnRzU3RvcmUgPSB1cGdyYWRlRGIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnRzJywgeyBrZXlQYXRoOiAnaWQnIH0pO1xuICAgICAgICAgIHJlc3RhdXJhbnRzU3RvcmUuY3JlYXRlSW5kZXgoJ2J5LW5hbWUnLCAnbmFtZScpO1xuICAgICAgICAgIHJlc3RhdXJhbnRzU3RvcmUuY3JlYXRlSW5kZXgoJ2J5LWRhdGUnLCAnY3JlYXRlZEF0Jyk7XG4gICAgICAgICAgcmVzdGF1cmFudHNTdG9yZS5jcmVhdGVJbmRleCgnYnktY3Vpc2luZScsICdjdWlzaW5lX3R5cGUnKTtcbiAgICAgICAgICByZXN0YXVyYW50c1N0b3JlLmNyZWF0ZUluZGV4KCdieS1uZWlnaGJvcmhvb2QnLCAnbmVpZ2hib3Job29kJyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggYWxsIHJlc3RhdXJhbnRzLlxuICAgKi9cbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudHMoY2FsbGJhY2spIHtcblxuICAgIGZldGNoKERCSGVscGVyLkRBVEFCQVNFX1VSTCkudGhlbihyZXN0YXVyYW50cyA9PiB7XG4gICAgICByZXR1cm4gcmVzdGF1cmFudHMuanNvbigpO1xuICAgIH0pXG4gICAgICAudGhlbihyZXN0YXVyYW50cyA9PiB7XG4gICAgICAgIC8vSWYgb25saW5lIHJlcXVlc3QgcmV0dXJuIGRhdGEgZmlsbCBpZGJcbiAgICAgICAgdGhpcy5vcGVuUmVzdGF1cmFudHNEQigpLnRoZW4oZnVuY3Rpb24gKGRiKSB7XG4gICAgICAgICAgdmFyIHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnRzJywgJ3JlYWR3cml0ZScpXG4gICAgICAgICAgdmFyIHJlc3RhdXJhbnRzU3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmVzdGF1cmFudHMnKTtcbiAgICAgICAgICByZXN0YXVyYW50cy5mb3JFYWNoKHJlc3RhdXJhbnQgPT4ge1xuICAgICAgICAgICAgcmVzdGF1cmFudHNTdG9yZS5wdXQocmVzdGF1cmFudCk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICAvLyBsaW1pdCBzdG9yZSB0byAxMCBpdGVtc1xuICAgICAgICAgIHJlc3RhdXJhbnRzU3RvcmUuaW5kZXgoJ2J5LWRhdGUnKS5vcGVuQ3Vyc29yKG51bGwsIFwicHJldlwiKS50aGVuKGZ1bmN0aW9uKGN1cnNvcikge1xuICAgICAgICAgICAgcmV0dXJuIGN1cnNvci5hZHZhbmNlKDEwKTtcbiAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIGRlbGV0ZVJlc3QoY3Vyc29yKSB7XG4gICAgICAgICAgICBpZiAoIWN1cnNvcikgcmV0dXJuO1xuICAgICAgICAgICAgY3Vyc29yLmRlbGV0ZSgpO1xuICAgICAgICAgICAgcmV0dXJuIGN1cnNvci5jb250aW51ZSgpLnRoZW4oZGVsZXRlUmVzdCk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXN0YXVyYW50cylcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgLy9JZiBvbmxpbmUgcmVxdWVzdCBmYWlscyB0cnkgdG8gY2F0Y2ggbG9jYWwgaWRiIGRhdGFcbiAgICAgICAgdGhpcy5vcGVuUmVzdGF1cmFudHNEQigpLnRoZW4oZnVuY3Rpb24gKGRiKSB7XG4gICAgICAgICAgdmFyIHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnRzJylcbiAgICAgICAgICB2YXIgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmVzdGF1cmFudHMnKTtcbiAgICAgICAgICBzdG9yZS5nZXRBbGwoKS50aGVuKHJlc3RhdXJhbnRzID0+IHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnRzKVxuICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gY2FsbGJhY2soZXJyb3IsIG51bGwpKTtcbiAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gY2FsbGJhY2soZXJyb3IsIG51bGwpKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZldGNoIGEgcmVzdGF1cmFudCBieSBpdHMgSUQuXG4gICAqL1xuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlJZChpZCwgY2FsbGJhY2spIHtcbiAgICAvLyBmZXRjaCBhbGwgcmVzdGF1cmFudHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXG4gICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcmVzdGF1cmFudCA9IHJlc3RhdXJhbnRzLmZpbmQociA9PiByLmlkID09IGlkKTtcbiAgICAgICAgaWYgKHJlc3RhdXJhbnQpIHsgLy8gR290IHRoZSByZXN0YXVyYW50XG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdGF1cmFudCk7XG4gICAgICAgIH0gZWxzZSB7IC8vIFJlc3RhdXJhbnQgZG9lcyBub3QgZXhpc3QgaW4gdGhlIGRhdGFiYXNlXG4gICAgICAgICAgY2FsbGJhY2soJ1Jlc3RhdXJhbnQgZG9lcyBub3QgZXhpc3QnLCBudWxsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSB0eXBlIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxuICAgKi9cbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZShjdWlzaW5lLCBjYWxsYmFjaykge1xuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50cyAgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmdcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBGaWx0ZXIgcmVzdGF1cmFudHMgdG8gaGF2ZSBvbmx5IGdpdmVuIGN1aXNpbmUgdHlwZVxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5jdWlzaW5lX3R5cGUgPT0gY3Vpc2luZSk7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxuICAgKi9cbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5TmVpZ2hib3Job29kKG5laWdoYm9yaG9vZCwgY2FsbGJhY2spIHtcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBGaWx0ZXIgcmVzdGF1cmFudHMgdG8gaGF2ZSBvbmx5IGdpdmVuIG5laWdoYm9yaG9vZFxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0cyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggcmVzdGF1cmFudHMgYnkgYSBjdWlzaW5lIGFuZCBhIG5laWdoYm9yaG9vZCB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cbiAgICovXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCBjYWxsYmFjaykge1xuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCByZXN1bHRzID0gcmVzdGF1cmFudHM7XG4gICAgICAgIGlmIChjdWlzaW5lICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBjdWlzaW5lXG4gICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5jdWlzaW5lX3R5cGUgPT0gY3Vpc2luZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5laWdoYm9yaG9vZCAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgbmVpZ2hib3Job29kXG4gICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcbiAgICAgICAgfVxuICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaCBhbGwgbmVpZ2hib3Job29kcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cbiAgICovXG4gIHN0YXRpYyBmZXRjaE5laWdoYm9yaG9vZHMoY2FsbGJhY2spIHtcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBHZXQgYWxsIG5laWdoYm9yaG9vZHMgZnJvbSBhbGwgcmVzdGF1cmFudHNcbiAgICAgICAgY29uc3QgbmVpZ2hib3Job29kcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0ubmVpZ2hib3Job29kKTtcbiAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMgZnJvbSBuZWlnaGJvcmhvb2RzXG4gICAgICAgIGNvbnN0IHVuaXF1ZU5laWdoYm9yaG9vZHMgPSBuZWlnaGJvcmhvb2RzLmZpbHRlcigodiwgaSkgPT4gbmVpZ2hib3Job29kcy5pbmRleE9mKHYpID09IGkpO1xuICAgICAgICBjYWxsYmFjayhudWxsLCB1bmlxdWVOZWlnaGJvcmhvb2RzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaCBhbGwgY3Vpc2luZXMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXG4gICAqL1xuICBzdGF0aWMgZmV0Y2hDdWlzaW5lcyhjYWxsYmFjaykge1xuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIEdldCBhbGwgY3Vpc2luZXMgZnJvbSBhbGwgcmVzdGF1cmFudHNcbiAgICAgICAgY29uc3QgY3Vpc2luZXMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLmN1aXNpbmVfdHlwZSk7XG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gY3Vpc2luZXNcbiAgICAgICAgY29uc3QgdW5pcXVlQ3Vpc2luZXMgPSBjdWlzaW5lcy5maWx0ZXIoKHYsIGkpID0+IGN1aXNpbmVzLmluZGV4T2YodikgPT0gaSk7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHVuaXF1ZUN1aXNpbmVzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXN0YXVyYW50IHBhZ2UgVVJMLlxuICAgKi9cbiAgc3RhdGljIHVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xuICAgIHJldHVybiAoYC4vcmVzdGF1cmFudD9pZD0ke3Jlc3RhdXJhbnQuaWR9YCk7XG4gIH1cblxuICAvKipcbiAgICogUmVzdGF1cmFudCBpbWFnZSBVUkwuXG4gICAqL1xuICBzdGF0aWMgaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcbiAgICByZXR1cm4gcmVzdGF1cmFudC5waG90b2dyYXBoID09IG51bGwgPyAnL2ltZy9taXNzaW5nLWltYWdlJyA6IChgL2ltZy8ke3Jlc3RhdXJhbnQucGhvdG9ncmFwaH1gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYXAgbWFya2VyIGZvciBhIHJlc3RhdXJhbnQuXG4gICAqL1xuICBzdGF0aWMgbWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBtYXApIHtcbiAgICBjb25zdCBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcbiAgICAgIHBvc2l0aW9uOiByZXN0YXVyYW50LmxhdGxuZyxcbiAgICAgIHRpdGxlOiByZXN0YXVyYW50Lm5hbWUsXG4gICAgICB1cmw6IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCksXG4gICAgICBtYXA6IG1hcCxcbiAgICAgIGFuaW1hdGlvbjogZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkRST1B9XG4gICAgKTtcbiAgICByZXR1cm4gbWFya2VyO1xuICB9XG5cbiAgc3RhdGljIGNsZWFuSW1hZ2VDYWNoZSgpIHtcbiAgICByZXR1cm4gREJIZWxwZXIub3BlblJlc3RhdXJhbnRzREIoKS50aGVuKGZ1bmN0aW9uKGRiKSB7XG4gICAgICBpZiAoIWRiKSByZXR1cm47XG5cbiAgICAgIHZhciBpbWFnZXNOZWVkZWQgPSBbXTtcblxuICAgICAgdmFyIHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnRzJyk7XG4gICAgICByZXR1cm4gdHgub2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnRzJykuZ2V0QWxsKCkudGhlbihmdW5jdGlvbihyZXN0YXVyYW50cykge1xuICAgICAgICByZXN0YXVyYW50cy5mb3JFYWNoKGZ1bmN0aW9uKHJlc3RhdXJhbnQpIHtcbiAgICAgICAgICBpZiAocmVzdGF1cmFudC5waG90b2dyYXBoKSB7XG4gICAgICAgICAgICBpbWFnZXNOZWVkZWQucHVzaChyZXN0YXVyYW50LnBob3RvZ3JhcGgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGNhY2hlcy5vcGVuKCdyZXN0YXVyYW50LXJldmlld3MtY29udGVudC1pbWdzJyk7XG4gICAgICB9KS50aGVuKGZ1bmN0aW9uKGNhY2hlKSB7XG4gICAgICAgIHJldHVybiBjYWNoZS5rZXlzKCkudGhlbihmdW5jdGlvbihyZXF1ZXN0cykge1xuICAgICAgICAgIHJlcXVlc3RzLmZvckVhY2goZnVuY3Rpb24ocmVxdWVzdCkge1xuICAgICAgICAgICAgdmFyIHVybCA9IG5ldyBVUkwocmVxdWVzdC51cmwpO1xuICAgICAgICAgICAgdmFyIHVybEluZGV4ID0gdXJsLnBhdGhuYW1lcy5zdWJzdHJpbmcoMCwgdXJsLnBhdGhuYW1lcy5pbmRleE9mKCdfJykpO1xuICAgICAgICAgICAgaWYgKCFpbWFnZXNOZWVkZWQuaW5jbHVkZXModXJsSW5kZXgpKSBjYWNoZS5kZWxldGUocmVxdWVzdCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxufVxuIl19
